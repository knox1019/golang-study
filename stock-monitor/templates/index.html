<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>è‡ªé€‰è‚¡ç›‘æ§å®¤</title>
    <!-- å¼•å…¥ Chart.js å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        #price-display { font-size: 48px; font-weight: bold; color: #d32f2f; margin: 20px 0; }
        .controls { margin: 20px; padding: 20px; background: #f5f5f5; border-radius: 8px; }
        .chart-container { width: 80%; margin: 0 auto; }
    </style>
</head>
<body>

    <h1>ğŸ“ˆ å®æ—¶è‚¡ä»·ç›‘æ§</h1>
    
    <!-- æ˜¾ç¤ºå½“å‰ä»·æ ¼ -->
    <div id="price-display">Loading...</div>

    <!-- æ§åˆ¶åŒºåŸŸ -->
    <div class="controls">
        <label>
            <input type="checkbox" id="speech-toggle"> å¼€å¯è¯­éŸ³æ’­æŠ¥
        </label>
        <span style="margin-left: 20px;">
            æ’­æŠ¥é—´éš”(ç§’): <input type="number" id="speech-interval" value="5" style="width: 50px;">
        </span>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="chart-container">
        <canvas id="stockChart"></canvas>
    </div>

    <script>
        // --- 1. åˆå§‹åŒ–å›¾è¡¨ ---
        const ctx = document.getElementById('stockChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line', // æŠ˜çº¿å›¾
            data: {
                labels: [], // Xè½´ï¼šæ—¶é—´
                datasets: [{
                    label: 'æ¨¡æ‹Ÿè‚¡ä»· (MOCK)',
                    data: [], // Yè½´ï¼šä»·æ ¼
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                }]
            }
        });

        // --- 2. è¯­éŸ³æ’­æŠ¥é€»è¾‘ ---
        let lastSpeechTime = 0; // ä¸Šæ¬¡æ’­æŠ¥çš„æ—¶é—´æˆ³

        function speakPrice(price) {
            const toggle = document.getElementById('speech-toggle').checked;
            const interval = document.getElementById('speech-interval').value * 1000; // è½¬æ¯«ç§’
            const now = Date.now();

            if (toggle && (now - lastSpeechTime > interval)) {
                // è°ƒç”¨æµè§ˆå™¨è‡ªå¸¦çš„è¯­éŸ³åˆæˆ
                const msg = new SpeechSynthesisUtterance(`å½“å‰ä»·æ ¼ ${price.toFixed(2)}`);
                window.speechSynthesis.speak(msg);
                lastSpeechTime = now;
            }
        }

        // --- 3. å®šæ—¶æ‹‰å–æ•°æ® (AJAX) ---
        function fetchPrice() {
            fetch('/api/price')
                .then(response => response.json())
                .then(data => {
                    // æ›´æ–°å¤§å­—æ˜¾ç¤º
                    const priceFixed = data.price.toFixed(2);
                    document.getElementById('price-display').innerText = priceFixed;

                    // æ›´æ–°å›¾è¡¨
                    if (chart.data.labels.length > 20) { // åªä¿ç•™æœ€è¿‘20ä¸ªç‚¹
                        chart.data.labels.shift();
                        chart.data.datasets[0].data.shift();
                    }
                    chart.data.labels.push(data.time);
                    chart.data.datasets[0].data.push(data.price);
                    chart.update();

                    // å°è¯•æ’­æŠ¥
                    speakPrice(data.price);
                });
        }

        // æ¯ 1 ç§’å‘ Go åç«¯è¯·æ±‚ä¸€æ¬¡æ•°æ®
        setInterval(fetchPrice, 1000);
    </script>
</body>
</html>